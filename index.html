<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recipes Browser</title>

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .truncate-two {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;  
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const API_BASE = "http://127.0.0.1:8000";

    function StarRating({ value }) {
      const v = Number(value ?? 0);
      return (
        <span className="text-yellow-500">
          {[1,2,3,4,5].map(i => (
            <span key={i}>{i <= Math.round(v) ? "★" : "☆"}</span>
          ))}
        </span>
      );
    }

    function Drawer({ open, onClose, recipe }) {
      if (!open) return null;
      const n = recipe?.nutrients || {};
      return (
        <div className="fixed inset-0 bg-black/30 flex justify-end">
          <div className="bg-white w-full sm:w-[520px] h-full overflow-y-auto shadow-xl p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-xl font-bold">{recipe?.title}</h2>
                <p className="text-sm text-gray-500">{recipe?.cuisine}</p>
              </div>
              <button className="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200" onClick={onClose}>Close</button>
            </div>

            <div className="space-y-4">
              <section>
                <h3 className="font-semibold mb-1">Description</h3>
                <p className="text-gray-700">{recipe?.description || "-"}</p>
              </section>

              <section>
                <details className="rounded border p-3">
                  <summary className="cursor-pointer font-semibold">
                    Total Time: {recipe?.total_time ?? "-"} mins
                  </summary>
                  <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                    <div className="p-2 rounded bg-gray-50">Prep: {recipe?.prep_time ?? "-"} mins</div>
                    <div className="p-2 rounded bg-gray-50">Cook: {recipe?.cook_time ?? "-"} mins</div>
                  </div>
                </details>
              </section>

              <section>
                <h3 className="font-semibold mb-2">Nutrition</h3>
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <tbody className="divide-y">
                      {[
                        "calories","carbohydrateContent","cholesterolContent","fiberContent",
                        "proteinContent","saturatedFatContent","sodiumContent","sugarContent","fatContent"
                      ].map(k => (
                        <tr key={k}>
                          <td className="py-1 pr-4 font-medium">{k}</td>
                          <td className="py-1">{n?.[k] ?? "-"}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </section>
            </div>
          </div>
        </div>
      );
    }

    function useDebouncedValue(value, delay=400) {
      const [v, setV] = React.useState(value);
      React.useEffect(() => {
        const id = setTimeout(() => setV(value), delay);
        return () => clearTimeout(id);
      }, [value, delay]);
      return v;
    }

    function App() {
      const [rows, setRows] = React.useState([]);
      const [page, setPage] = React.useState(1);
      const [limit, setLimit] = React.useState(15);
      const [total, setTotal] = React.useState(0);
      const [loading, setLoading] = React.useState(false);
      const [open, setOpen] = React.useState(false);
      const [selected, setSelected] = React.useState(null);
      const [filters, setFilters] = React.useState({
        title: "", cuisine: "", rating: "", total_time: "", calories: ""
      });

      const deb = {
        title: useDebouncedValue(filters.title),
        cuisine: useDebouncedValue(filters.cuisine),
        rating: useDebouncedValue(filters.rating),
        total_time: useDebouncedValue(filters.total_time),
        calories: useDebouncedValue(filters.calories),
      };

      const isFiltering = Object.values(deb).some(v => (v ?? "").trim().length > 0);

      async function fetchData() {
        setLoading(true);
        try {
          let url;
          if (isFiltering) {
            const params = new URLSearchParams();
            if (deb.title) params.set("title", deb.title);
            if (deb.cuisine) params.set("cuisine", deb.cuisine);
            if (deb.rating) params.set("rating", deb.rating);
            if (deb.total_time) params.set("total_time", deb.total_time);
            if (deb.calories) params.set("calories", deb.calories);
            params.set("page", page);
            params.set("limit", limit);
            url = `${API_BASE}/api/recipes/search?${params.toString()}`;
          } else {
            url = `${API_BASE}/api/recipes?page=${page}&limit=${limit}`;
          }
          const res = await fetch(url);
          const j = await res.json();
          setRows(j.data || []);
          setTotal(j.total || 0);
        } catch (e) {
          console.error(e);
          setRows([]); setTotal(0);
        } finally {
          setLoading(false);
        }
      }

      React.useEffect(() => { fetchData(); }, [page, limit, deb.title, deb.cuisine, deb.rating, deb.total_time, deb.calories]);

      const totalPages = Math.max(1, Math.ceil(total / limit));

      return (
        <div className="max-w-6xl mx-auto p-4">
          <h1 className="text-2xl font-bold mb-4">Recipes</h1>

          {/* Filters */}
          <div className="bg-white rounded-xl shadow p-4 mb-4">
            <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
              <input className="border rounded p-2" placeholder="Title" value={filters.title}
                onChange={e => {setPage(1); setFilters({...filters, title: e.target.value});}} />
              <input className="border rounded p-2" placeholder="Cuisine" value={filters.cuisine}
                onChange={e => {setPage(1); setFilters({...filters, cuisine: e.target.value});}} />
              <input className="border rounded p-2" placeholder="Rating (>=4.5)" value={filters.rating}
                onChange={e => {setPage(1); setFilters({...filters, rating: e.target.value});}} />
              <input className="border rounded p-2" placeholder="Total time (<=30)" value={filters.total_time}
                onChange={e => {setPage(1); setFilters({...filters, total_time: e.target.value});}} />
              <input className="border rounded p-2" placeholder="Calories (<=400)" value={filters.calories}
                onChange={e => {setPage(1); setFilters({...filters, calories: e.target.value});}} />
            </div>
          </div>

          {/* Table */}
          <div className="bg-white rounded-xl shadow overflow-hidden">
            <div className="overflow-x-auto">
              <table className="min-w-full">
                <thead className="bg-gray-100 text-left">
                  <tr>
                    <th className="p-3 w-1/2">Title</th>
                    <th className="p-3">Cuisine</th>
                    <th className="p-3">Rating</th>
                    <th className="p-3">Total Time</th>
                    <th className="p-3">Serves</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {loading ? (
                    <tr><td colSpan="5" className="p-6 text-center">Loading…</td></tr>
                  ) : rows.length === 0 ? (
                    <tr><td colSpan="5" className="text-center p-6">No results</td></tr>
                  ) : rows.map(r => (
                    <tr key={r.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => { setSelected(r); setOpen(true); }}>
                      <td className="p-3"><div className="truncate-two">{r.title}</div></td>
                      <td className="p-3">{r.cuisine || "-"}</td>
                      <td className="p-3"><StarRating value={r.rating} /></td>
                      <td className="p-3">{r.total_time ?? "-"}</td>
                      <td className="p-3">{r.serves ?? "-"}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Pagination */}
            <div className="flex items-center justify-between p-3 border-t bg-gray-50">
              <div className="flex items-center gap-2">
                <span className="text-sm">Rows per page:</span>
                <select className="border rounded p-1"
                  value={limit}
                  onChange={e => { setPage(1); setLimit(Number(e.target.value)); }}>
                  {[15,20,25,30,40,50].map(n => <option key={n} value={n}>{n}</option>)}
                </select>
                <span className="text-sm text-gray-500">Total: {total}</span>
              </div>
              <div className="flex items-center gap-2">
                <button disabled={page<=1} className="px-2 py-1 border rounded" onClick={() => setPage(1)}>« First</button>
                <button disabled={page<=1} className="px-2 py-1 border rounded" onClick={() => setPage(p => Math.max(1, p-1))}>‹ Prev</button>
                <span className="text-sm">Page {page} / {totalPages}</span>
                <button disabled={page>=totalPages} className="px-2 py-1 border rounded" onClick={() => setPage(p => Math.min(totalPages, p+1))}>Next ›</button>
                <button disabled={page>=totalPages} className="px-2 py-1 border rounded" onClick={() => setPage(totalPages)}>Last »</button>
              </div>
            </div>
          </div>

          <Drawer open={open} onClose={() => setOpen(false)} recipe={selected} />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
